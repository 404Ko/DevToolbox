@page "/other/regex"
@inject DevToolbox.Web.Services.IOtherToolService ToolService

<PageTitle>æ­£åˆ™æµ‹è¯• - DevToolbox</PageTitle>

@* AI Accept [Added]: Regex tester tool page *@
<div class="tool-page">
    <div class="tool-header">
        <h1>ğŸ” æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•</h1>
        <p>å®æ—¶æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€åˆ†ç»„æ•è·å’Œæ›¿æ¢</p>
    </div>

    @* AI Accept [Added]: Pattern and flags *@
    <div class="card">
        <div class="card-header">
            <span>âš™ï¸ æ­£åˆ™é…ç½®</span>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">æ­£åˆ™è¡¨è¾¾å¼</label>
                <input type="text" class="form-control" style="font-family: 'Consolas', monospace;"
                       placeholder="ä¾‹å¦‚: (\d{4})-(\d{2})-(\d{2})"
                       @bind="Pattern" @bind:event="oninput" />
            </div>

            <div class="options-row">
                <div class="option-item">
                    <input type="checkbox" id="rx-ignore" @bind="IgnoreCase" />
                    <label for="rx-ignore">å¿½ç•¥å¤§å°å†™ (i)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="rx-multi" @bind="Multiline" />
                    <label for="rx-multi">å¤šè¡Œæ¨¡å¼ (m)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="rx-single" @bind="Singleline" />
                    <label for="rx-single">å•è¡Œæ¨¡å¼ (s)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="rx-global" @bind="Global" />
                    <label for="rx-global">å…¨å±€åŒ¹é… (g)</label>
                </div>
            </div>
        </div>
    </div>

    @* AI Accept [Added]: Test input *@
    <div class="card" style="margin-top: 16px;">
        <div class="card-header">
            <span>ğŸ“ æµ‹è¯•æ–‡æœ¬</span>
        </div>
        <div class="card-body">
            <textarea class="form-control" rows="6" style="min-height: 120px;"
                      placeholder="è¾“å…¥è¦åŒ¹é…çš„æ–‡æœ¬..."
                      @bind="TestInput" @bind:event="oninput"></textarea>
        </div>
    </div>

    @* AI Accept [Added]: Optional replacement *@
    <div class="card" style="margin-top: 16px;">
        <div class="card-header">
            <span>ğŸ”„ æ›¿æ¢ï¼ˆå¯é€‰ï¼‰</span>
        </div>
        <div class="card-body">
            <input type="text" class="form-control" style="font-family: 'Consolas', monospace;"
                   placeholder="æ›¿æ¢å­—ç¬¦ä¸²ï¼Œæ”¯æŒ $1 $2 å¼•ç”¨åˆ†ç»„ï¼ˆç•™ç©ºåˆ™ä»…åŒ¹é…ï¼‰"
                   @bind="Replacement" @bind:event="oninput" />
        </div>
    </div>

    <div class="btn-group" style="margin-top: 20px; justify-content: center;">
        <button class="btn btn-primary" @onclick="RunTest">ğŸ” æµ‹è¯•åŒ¹é…</button>
        <button class="btn btn-secondary" @onclick="Clear">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button class="btn btn-secondary" @onclick="LoadExample">ğŸ“‹ åŠ è½½ç¤ºä¾‹</button>
    </div>

    @if (!string.IsNullOrEmpty(Result?.ErrorMessage))
    {
        <div class="alert alert-danger">@Result.ErrorMessage</div>
    }

    @* AI Accept [Added]: Match results *@
    @if (Result != null && Result.ErrorMessage == null)
    {
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <span>åŒ¹é…ç»“æœ</span>
                <span class="jwt-badge @(Result.MatchCount > 0 ? "jwt-badge-valid" : "jwt-badge-expired")">
                    @(Result.MatchCount > 0 ? $"âœ… {Result.MatchCount} ä¸ªåŒ¹é…" : "âŒ æ— åŒ¹é…")
                </span>
            </div>
            <div class="card-body">
                @if (Result.Matches.Any())
                {
                    <table class="jwt-claims-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 70px;">ä½ç½®</th>
                                <th>åŒ¹é…å†…å®¹</th>
                                <th>åˆ†ç»„</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Result.Matches.Count; i++)
                            {
                                var m = Result.Matches[i];
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td><code>@m.Index</code></td>
                                    <td><code class="jwt-claim-value">@m.Value</code></td>
                                    <td>
                                        @if (m.Groups.Any())
                                        {
                                            @foreach (var g in m.Groups)
                                            {
                                                <div style="font-size: 12px;">
                                                    <span style="color: var(--text-secondary);">@g.Name:</span>
                                                    <code>@g.Value</code>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <span style="color: var(--text-secondary); font-size: 12px;">â€”</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }

                @* AI Accept [Added]: Replacement result *@
                @if (Result.ReplaceResult != null)
                {
                    <div style="margin-top: 16px;">
                        <label class="form-label">æ›¿æ¢ç»“æœ</label>
                        <pre class="jwt-json">@Result.ReplaceResult</pre>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    // AI Accept [Added]: Regex tester page state
    private string Pattern { get; set; } = string.Empty;
    private string TestInput { get; set; } = string.Empty;
    private string Replacement { get; set; } = string.Empty;
    private bool IgnoreCase { get; set; } = false;
    private bool Multiline { get; set; } = false;
    private bool Singleline { get; set; } = false;
    private bool Global { get; set; } = true;
    private DevToolbox.Web.Services.RegexTestResult? Result { get; set; }

    private void RunTest()
    {
        if (string.IsNullOrEmpty(Pattern))
        {
            Result = new DevToolbox.Web.Services.RegexTestResult { ErrorMessage = "è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼" };
            return;
        }
        var replacement = string.IsNullOrEmpty(Replacement) ? null : Replacement;
        Result = ToolService.TestRegex(Pattern, TestInput, IgnoreCase, Multiline, Singleline, Global, replacement);
    }

    private void LoadExample()
    {
        Pattern = @"(\d{4})-(\d{2})-(\d{2})";
        TestInput = "Today is 2024-01-15, yesterday was 2024-01-14.\nEvent date: 2023-12-25";
        Replacement = "$2/$3/$1";
        Global = true;
    }

    private void Clear()
    {
        Pattern = string.Empty;
        TestInput = string.Empty;
        Replacement = string.Empty;
        Result = null;
    }
}
