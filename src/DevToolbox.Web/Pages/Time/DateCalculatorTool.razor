@page "/time/calculator"
@using DevToolbox.Web.Services
@inject ITimeService TimeService

<PageTitle>æ—¥æœŸè®¡ç®—å™¨ - DevToolbox</PageTitle>

@* Date calculator tool page (AI Accept) *@
<div class="tool-page">
    <div class="tool-header">
        <h1>ğŸ“… æ—¥æœŸè®¡ç®—å™¨</h1>
        <p>æ—¥æœŸé—´éš”è®¡ç®—ã€æ—¥æœŸåŠ å‡è¿ç®—</p>
    </div>

    <div class="tool-content">
        @* AI Accept [Added]: Date difference calculation section *@
        <div class="card">
            <div class="card-header">ğŸ“ æ—¥æœŸé—´éš”è®¡ç®—</div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" class="form-control" @bind="DiffStartDate" />
                </div>
                <div class="form-group">
                    <label class="form-label">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" class="form-control" @bind="DiffEndDate" />
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" @onclick="CalculateDiff">è®¡ç®—é—´éš”</button>
                    <button class="btn btn-sm btn-secondary" @onclick="SetDiffToToday">ç»“æŸè®¾ä¸ºä»Šå¤©</button>
                </div>

                @if (DiffResult != null)
                {
                    <div class="date-calc-result">
                        <div class="date-calc-result-title">
                            @if (DiffResult.IsNegative)
                            {
                                <span class="jwt-badge jwt-badge-expired">ç»“æŸæ—¥æœŸæ—©äºå¼€å§‹æ—¥æœŸï¼ˆå·²å–ç»å¯¹å€¼ï¼‰</span>
                            }
                        </div>

                        <div class="date-calc-primary">
                            @if (DiffResult.Years > 0)
                            {
                                <span class="date-calc-num">@DiffResult.Years</span><span class="date-calc-unit">å¹´</span>
                            }
                            @if (DiffResult.Months > 0)
                            {
                                <span class="date-calc-num">@DiffResult.Months</span><span class="date-calc-unit">ä¸ªæœˆ</span>
                            }
                            <span class="date-calc-num">@DiffResult.Days</span><span class="date-calc-unit">å¤©</span>
                        </div>

                        <div class="date-calc-details">
                            <div class="date-calc-detail-item">
                                <span class="date-calc-detail-val">@DiffResult.TotalDays.ToString("N0")</span>
                                <span class="date-calc-detail-label">æ€»å¤©æ•°</span>
                            </div>
                            <div class="date-calc-detail-item">
                                <span class="date-calc-detail-val">@DiffResult.TotalWeeks.ToString("N0")</span>
                                <span class="date-calc-detail-label">æ€»å‘¨æ•°</span>
                            </div>
                            <div class="date-calc-detail-item">
                                <span class="date-calc-detail-val">@DiffResult.TotalHours.ToString("N0")</span>
                                <span class="date-calc-detail-label">æ€»å°æ—¶</span>
                            </div>
                            <div class="date-calc-detail-item">
                                <span class="date-calc-detail-val">@DiffResult.TotalMinutes.ToString("N0")</span>
                                <span class="date-calc-detail-label">æ€»åˆ†é’Ÿ</span>
                            </div>
                            <div class="date-calc-detail-item">
                                <span class="date-calc-detail-val">@DiffResult.TotalSeconds.ToString("N0")</span>
                                <span class="date-calc-detail-label">æ€»ç§’æ•°</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* AI Accept [Added]: Date add/subtract calculation section *@
        <div class="card">
            <div class="card-header">â• æ—¥æœŸåŠ å‡è¿ç®—</div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">åŸºå‡†æ—¥æœŸ</label>
                    <input type="date" class="form-control" @bind="AddBaseDate" />
                </div>

                <div class="options-row" style="margin-bottom: 12px;">
                    <label class="option-item">
                        <input type="radio" name="addMode" checked="@(!IsSubtract)"
                               @onchange="@(() => IsSubtract = false)" />
                        <span>åŠ </span>
                    </label>
                    <label class="option-item">
                        <input type="radio" name="addMode" checked="@IsSubtract"
                               @onchange="@(() => IsSubtract = true)" />
                        <span>å‡</span>
                    </label>
                </div>

                <div class="date-calc-inputs">
                    <div class="form-group date-calc-input-item">
                        <label class="form-label">å¹´</label>
                        <input type="number" class="form-control" @bind="AddYears" min="0" />
                    </div>
                    <div class="form-group date-calc-input-item">
                        <label class="form-label">æœˆ</label>
                        <input type="number" class="form-control" @bind="AddMonths" min="0" />
                    </div>
                    <div class="form-group date-calc-input-item">
                        <label class="form-label">å‘¨</label>
                        <input type="number" class="form-control" @bind="AddWeeks" min="0" />
                    </div>
                    <div class="form-group date-calc-input-item">
                        <label class="form-label">å¤©</label>
                        <input type="number" class="form-control" @bind="AddDays" min="0" />
                    </div>
                </div>

                <button class="btn btn-success" @onclick="CalculateAdd">è®¡ç®—ç»“æœ</button>

                @if (!string.IsNullOrEmpty(AddResult))
                {
                    <div class="date-calc-result">
                        <div class="date-calc-primary">
                            <span class="date-calc-num" style="font-size: 20px;">@AddResult</span>
                        </div>
                        <div class="date-calc-details">
                            <div class="date-calc-detail-item">
                                <span class="date-calc-detail-val">@AddResultWeekday</span>
                                <span class="date-calc-detail-label">æ˜ŸæœŸ</span>
                            </div>
                            <div class="date-calc-detail-item">
                                <span class="date-calc-detail-val">@AddResultDayOfYear</span>
                                <span class="date-calc-detail-label">å½“å¹´ç¬¬Nå¤©</span>
                            </div>
                            <div class="date-calc-detail-item">
                                <span class="date-calc-detail-val">@AddResultIsLeap</span>
                                <span class="date-calc-detail-label">é—°å¹´</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }
</div>

@code {
    // AI Accept [Added]: Date diff state
    private DateTime DiffStartDate { get; set; } = DateTime.Today;
    private DateTime DiffEndDate { get; set; } = DateTime.Today;
    private DateDiffResult? DiffResult { get; set; }

    // AI Accept [Added]: Date add/subtract state
    private DateTime AddBaseDate { get; set; } = DateTime.Today;
    private bool IsSubtract { get; set; } = false;
    private int AddYears { get; set; } = 0;
    private int AddMonths { get; set; } = 0;
    private int AddWeeks { get; set; } = 0;
    private int AddDays { get; set; } = 0;
    private string AddResult { get; set; } = string.Empty;
    private string AddResultWeekday { get; set; } = string.Empty;
    private string AddResultDayOfYear { get; set; } = string.Empty;
    private string AddResultIsLeap { get; set; } = string.Empty;

    private string ErrorMessage { get; set; } = string.Empty;

    /// <summary>
    /// Calculate date difference (AI Accept)
    /// </summary>
    private void CalculateDiff()
    {
        ErrorMessage = string.Empty;
        DiffResult = null;

        try
        {
            DiffResult = TimeService.CalculateDateDiff(DiffStartDate, DiffEndDate);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"è®¡ç®—å¤±è´¥ï¼š{ex.Message}";
        }
    }

    /// <summary>
    /// Set end date to today (AI Accept)
    /// </summary>
    private void SetDiffToToday()
    {
        DiffEndDate = DateTime.Today;
    }

    // AI Accept [Added]: Chinese weekday names
    private static readonly string[] WeekdayNames = { "æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­" };

    /// <summary>
    /// Calculate date addition/subtraction (AI Accept)
    /// </summary>
    private void CalculateAdd()
    {
        ErrorMessage = string.Empty;
        AddResult = string.Empty;

        try
        {
            var result = TimeService.AddToDate(AddBaseDate, AddYears, AddMonths, AddWeeks, AddDays, IsSubtract);
            AddResult = result.ToString("yyyy-MM-dd");
            AddResultWeekday = $"æ˜ŸæœŸ{WeekdayNames[(int)result.DayOfWeek]}";
            AddResultDayOfYear = result.DayOfYear.ToString();
            AddResultIsLeap = DateTime.IsLeapYear(result.Year) ? "æ˜¯" : "å¦";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"è®¡ç®—å¤±è´¥ï¼š{ex.Message}";
        }
    }
}
