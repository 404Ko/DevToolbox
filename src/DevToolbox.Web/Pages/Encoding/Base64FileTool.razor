@page "/encoding/base64-file"
@inject DevToolbox.Web.Services.IEncodingService EncodingService
@inject IJSRuntime JS

<PageTitle>Base64 è½¬æ–‡ä»¶ - DevToolbox</PageTitle>

@* AI Accept [Added]: Base64 â†” File converter tool page *@
<div class="tool-page">
    <div class="tool-header">
        <h1>ğŸ“ Base64 â†” æ–‡ä»¶è½¬æ¢</h1>
        <p>æ–‡ä»¶ä¸ Base64 äº’è½¬ï¼šä¸Šä¼ æ–‡ä»¶ç”Ÿæˆ Base64ï¼Œæˆ–ç²˜è´´ Base64 è¿˜åŸä¸ºæ–‡ä»¶ä¸‹è½½</p>
    </div>

    <div class="tool-content">
        @* AI Accept [Added]: File â†’ Base64 section *@
        <div class="card">
            <div class="card-header">
                <span>ğŸ“¤ æ–‡ä»¶ â†’ Base64</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                    <InputFile OnChange="OnFileUpload" class="form-control"
                               style="padding: 8px;" accept="*/*" />
                </div>

                @if (UploadInfo != null)
                {
                    <div class="b64file-info">
                        <span>ğŸ“„ @UploadInfo.FileName</span>
                        <span>@FormatSize(UploadInfo.FileSize)</span>
                        <span>@UploadInfo.MimeType</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(EncodeResult))
                {
                    <div class="form-group" style="margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <label class="form-label" style="margin-bottom: 0;">Base64 ç»“æœ</label>
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <input type="checkbox" id="chk-datauri" @bind="IncludeDataUri" @bind:after="RefreshEncodeResult" />
                                <label for="chk-datauri" style="font-size: 12px;">åŒ…å« Data URI å‰ç¼€</label>
                            </div>
                        </div>
                        <textarea class="form-control" rows="6" readonly
                                  style="min-height: 120px; font-size: 12px;"
                                  value="@GetDisplayResult()"></textarea>
                    </div>
                    <div class="btn-group" style="margin-top: 8px;">
                        <button class="btn btn-sm btn-secondary" @onclick="CopyEncodeResult">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                    <div style="margin-top: 6px; font-size: 12px; color: var(--text-secondary);">
                        Base64 é•¿åº¦ï¼š@GetDisplayResult().Length å­—ç¬¦ï¼ˆåŸå§‹ @FormatSize(UploadInfo?.FileSize ?? 0) â†’ ç¼–ç å @FormatSize(EncodeResult.Length)ï¼‰
                    </div>
                }

                @if (!string.IsNullOrEmpty(UploadError))
                {
                    <div class="alert alert-danger">@UploadError</div>
                }
            </div>
        </div>

        @* AI Accept [Added]: Base64 â†’ File section *@
        <div class="card">
            <div class="card-header">
                <span>ğŸ“¥ Base64 â†’ æ–‡ä»¶</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">ç²˜è´´ Base64ï¼ˆæ”¯æŒ Data URI æ ¼å¼ï¼‰</label>
                    <textarea class="form-control" rows="6"
                              style="min-height: 120px; font-size: 12px;"
                              placeholder="ç²˜è´´ Base64 ç¼–ç å­—ç¬¦ä¸²...&#10;æ”¯æŒæ ¼å¼ï¼š&#10;  data:image/png;base64,iVBORw0KGgo...&#10;  iVBORw0KGgo... (çº¯ Base64)"
                              @bind="DecodeInput"></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" @onclick="DecodeAndAnalyze">ğŸ” è§£æ</button>
                    <button class="btn btn-secondary" @onclick="ClearDecode">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>

                @if (!string.IsNullOrEmpty(DecodeError))
                {
                    <div class="alert alert-danger">@DecodeError</div>
                }

                @if (DecodeInfo != null)
                {
                    <div class="b64file-info" style="margin-top: 12px;">
                        <span>ğŸ“„ æ£€æµ‹ç±»å‹ï¼š@DecodeInfo.MimeType</span>
                        <span>æ–‡ä»¶å¤§å°ï¼š@FormatSize(DecodeInfo.FileSize)</span>
                        <span>æ‰©å±•åï¼š@DecodeInfo.Extension</span>
                    </div>

                    @* AI Accept [Added]: Image preview *@
                    @if (DecodeInfo.MimeType.StartsWith("image/") && DecodeInfo.FileSize < 5 * 1024 * 1024)
                    {
                        <div style="margin-top: 12px; text-align: center;">
                            <img src="data:@DecodeInfo.MimeType;base64,@DecodeInfo.Base64Data"
                                 style="max-width: 100%; max-height: 300px; border: 1px solid var(--border-color); border-radius: 6px;"
                                 alt="Preview" />
                        </div>
                    }

                    <div class="form-group" style="margin-top: 12px;">
                        <label class="form-label">æ–‡ä»¶å</label>
                        @* AI Accept [Modified]: Extension field editable for manual override *@
                        <div style="display: flex; align-items: center; gap: 0; max-width: 360px;">
                            <input type="text" class="form-control"
                                   style="border-top-right-radius: 0; border-bottom-right-radius: 0; flex: 1;"
                                   @bind="DownloadFileBaseName" />
                            <input type="text" class="form-control"
                                   style="border-radius: 0; border-left: none; width: 70px; font-family: 'Consolas', monospace; font-size: 14px; text-align: center;"
                                   @bind="DownloadFileExtension" />
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            æ£€æµ‹åç¼€ï¼š<code>@DecodeInfo.Extension</code>ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰
                        </div>
                    </div>

                    <button class="btn btn-success" style="margin-top: 8px;" @onclick="DownloadFile">
                        â¬‡ï¸ ä¸‹è½½æ–‡ä»¶
                    </button>
                }
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success">@SuccessMessage</div>
    }
</div>

@code {
    // AI Accept [Added]: Base64 â†” File converter state

    // === File â†’ Base64 ===
    private string EncodeResult { get; set; } = string.Empty;
    private string UploadError { get; set; } = string.Empty;
    private bool IncludeDataUri { get; set; } = true;
    private FileUploadInfo? UploadInfo { get; set; }
    private string UploadMimeType { get; set; } = string.Empty;

    // === Base64 â†’ File ===
    private string DecodeInput { get; set; } = string.Empty;
    private string DecodeError { get; set; } = string.Empty;
    private string DownloadFileBaseName { get; set; } = "download";
    // AI Accept [Added]: Editable extension field, auto-set from detection but user can override
    private string DownloadFileExtension { get; set; } = ".bin";
    private FileDecodeInfo? DecodeInfo { get; set; }

    private string SuccessMessage { get; set; } = string.Empty;

    // AI Accept [Added]: Max upload size (10MB)
    private const long MaxFileSize = 10 * 1024 * 1024;

    private class FileUploadInfo
    {
        public string FileName { get; set; } = string.Empty;
        public long FileSize { get; set; }
        public string MimeType { get; set; } = string.Empty;
    }

    private class FileDecodeInfo
    {
        public string MimeType { get; set; } = string.Empty;
        public string Extension { get; set; } = string.Empty;
        public long FileSize { get; set; }
        public string Base64Data { get; set; } = string.Empty;
    }

    /// <summary>
    /// Handle file upload via InputFile (AI Accept)
    /// </summary>
    private async Task OnFileUpload(InputFileChangeEventArgs e)
    {
        UploadError = string.Empty;
        EncodeResult = string.Empty;
        UploadInfo = null;
        SuccessMessage = string.Empty;

        var file = e.File;
        if (file == null) return;

        if (file.Size > MaxFileSize)
        {
            UploadError = $"æ–‡ä»¶å¤ªå¤§ï¼ˆ{FormatSize(file.Size)}ï¼‰ï¼Œæœ€å¤§æ”¯æŒ 10MB";
            return;
        }

        try
        {
            // AI Accept [Added]: Read file bytes via stream
            using var stream = file.OpenReadStream(MaxFileSize);
            using var ms = new System.IO.MemoryStream();
            await stream.CopyToAsync(ms);
            var bytes = ms.ToArray();

            EncodeResult = EncodingService.Base64EncodeBytes(bytes);
            UploadMimeType = !string.IsNullOrEmpty(file.ContentType)
                ? file.ContentType
                : EncodingService.DetectMimeType(bytes);

            UploadInfo = new FileUploadInfo
            {
                FileName = file.Name,
                FileSize = file.Size,
                MimeType = UploadMimeType
            };
        }
        catch (Exception ex)
        {
            UploadError = $"è¯»å–æ–‡ä»¶å¤±è´¥ï¼š{ex.Message}";
        }
    }

    private string GetDisplayResult()
    {
        if (string.IsNullOrEmpty(EncodeResult)) return string.Empty;
        return IncludeDataUri
            ? $"data:{UploadMimeType};base64,{EncodeResult}"
            : EncodeResult;
    }

    private void RefreshEncodeResult() { /* triggers re-render */ }

    /// <summary>
    /// Copy encode result to clipboard (AI Accept)
    /// </summary>
    private async Task CopyEncodeResult()
    {
        SuccessMessage = string.Empty;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", GetDisplayResult());
            SuccessMessage = "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿";
        }
        catch
        {
            UploadError = "å¤åˆ¶å¤±è´¥";
        }
    }

    /// <summary>
    /// Decode Base64 and analyze file type (AI Accept)
    /// </summary>
    private void DecodeAndAnalyze()
    {
        DecodeError = string.Empty;
        DecodeInfo = null;
        SuccessMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(DecodeInput))
        {
            DecodeError = "è¯·è¾“å…¥ Base64 å­—ç¬¦ä¸²";
            return;
        }

        try
        {
            var bytes = EncodingService.Base64DecodeBytes(DecodeInput);
            if (bytes.Length == 0)
            {
                DecodeError = "è§£ç ç»“æœä¸ºç©º";
                return;
            }

            // AI Accept [Added]: Extract MIME from data URI if present, otherwise detect
            var mime = "application/octet-stream";
            var trimmed = DecodeInput.Trim();
            if (trimmed.StartsWith("data:", StringComparison.OrdinalIgnoreCase))
            {
                var semiIdx = trimmed.IndexOf(';');
                if (semiIdx > 5)
                    mime = trimmed[5..semiIdx];
            }
            else
            {
                mime = EncodingService.DetectMimeType(bytes);
            }

            var ext = EncodingService.GetExtensionFromMime(mime);

            // AI Accept [Added]: Extract pure base64 for preview/download
            var pureBase64 = trimmed;
            var commaIdx = pureBase64.IndexOf(',');
            if (commaIdx >= 0 && pureBase64.StartsWith("data:", StringComparison.OrdinalIgnoreCase))
                pureBase64 = pureBase64[(commaIdx + 1)..];

            DecodeInfo = new FileDecodeInfo
            {
                MimeType = mime,
                Extension = ext,
                FileSize = bytes.Length,
                Base64Data = pureBase64.Replace("\n", "").Replace("\r", "").Replace(" ", "")
            };

            DownloadFileBaseName = "download";
            // AI Accept [Added]: Set editable extension from detected type
            DownloadFileExtension = ext;
        }
        catch (FormatException)
        {
            DecodeError = "Base64 æ ¼å¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥è¾“å…¥";
        }
        catch (Exception ex)
        {
            DecodeError = $"è§£æå¤±è´¥ï¼š{ex.Message}";
        }
    }

    /// <summary>
    /// Download decoded file via JS interop (AI Accept)
    /// </summary>
    private async Task DownloadFile()
    {
        if (DecodeInfo == null) return;
        SuccessMessage = string.Empty;

        try
        {
            // AI Accept [Modified]: Use user-editable extension field for download
            var fullFileName = DownloadFileBaseName + DownloadFileExtension;
            var safeFileName = fullFileName.Replace("'", "\\'");
            var js = "(function(){var a=document.createElement('a');"
                + "a.href='data:" + DecodeInfo.MimeType + ";base64," + DecodeInfo.Base64Data + "';"
                + "a.download='" + safeFileName + "';"
                + "document.body.appendChild(a);a.click();document.body.removeChild(a);})();";
            await JS.InvokeVoidAsync("eval", js);
            SuccessMessage = $"æ–‡ä»¶ \"{fullFileName}\" å·²å¼€å§‹ä¸‹è½½";
        }
        catch (Exception ex)
        {
            DecodeError = $"ä¸‹è½½å¤±è´¥ï¼š{ex.Message}";
        }
    }

    private void ClearDecode()
    {
        DecodeInput = string.Empty;
        DecodeError = string.Empty;
        DecodeInfo = null;
        DownloadFileBaseName = "download";
        DownloadFileExtension = ".bin"; // AI Accept [Added]: Reset extension on clear
        SuccessMessage = string.Empty;
    }

    /// <summary>
    /// Format file size to human readable (AI Accept)
    /// </summary>
    private string FormatSize(long bytes)
    {
        if (bytes >= 1048576) return $"{bytes / 1048576.0:F1} MB";
        if (bytes >= 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes} B";
    }
}
