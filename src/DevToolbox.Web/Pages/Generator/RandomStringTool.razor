@page "/generator/random-string"
@inject DevToolbox.Web.Services.IGeneratorService GeneratorService
@inject IJSRuntime JS

<PageTitle>éšæœºå­—ç¬¦ä¸² - DevToolbox</PageTitle>

@* AI Accept [Added]: Random string generator tool page *@
<div class="tool-page">
    <div class="tool-header">
        <h1>ğŸ² éšæœºå­—ç¬¦ä¸²ç”Ÿæˆå™¨</h1>
        <p>ç”ŸæˆæŒ‡å®šé•¿åº¦å’Œå­—ç¬¦é›†çš„éšæœºå­—ç¬¦ä¸²ï¼Œä½¿ç”¨åŠ å¯†å®‰å…¨éšæœºæ•°</p>
    </div>

    <div class="card">
        <div class="card-header">
            <span>âš™ï¸ ç”Ÿæˆé€‰é¡¹</span>
        </div>
        <div class="card-body">
            @* AI Accept [Added]: Length and count controls *@
            <div class="options-row">
                <div class="option-item">
                    <label>å­—ç¬¦ä¸²é•¿åº¦ï¼š</label>
                    <input type="number" min="1" max="1024" style="width: 90px;" class="form-control"
                           @bind="Length" />
                </div>
                <div class="option-item">
                    <label>
                        <input type="range" min="1" max="128" @bind="Length" @bind:event="oninput"
                               style="width: 160px; vertical-align: middle;" />
                        @Length å­—ç¬¦
                    </label>
                </div>
                <div class="option-item">
                    <label>ç”Ÿæˆæ•°é‡ï¼š</label>
                    <input type="number" min="1" max="100" style="width: 80px;" class="form-control"
                           @bind="Count" />
                </div>
            </div>

            @* AI Accept [Added]: Character set checkboxes *@
            <div class="options-row" style="margin-top: 12px;">
                <div class="option-item">
                    <input type="checkbox" id="chk-upper" @bind="IncludeUpper" />
                    <label for="chk-upper">å¤§å†™å­—æ¯ (A-Z)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="chk-lower" @bind="IncludeLower" />
                    <label for="chk-lower">å°å†™å­—æ¯ (a-z)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="chk-numbers" @bind="IncludeNumbers" />
                    <label for="chk-numbers">æ•°å­— (0-9)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="chk-special" @bind="IncludeSpecial" />
                    <label for="chk-special">ç‰¹æ®Šå­—ç¬¦ (!@@#$%...)</label>
                </div>
            </div>

            @* AI Accept [Added]: Custom characters and separator *@
            <div class="options-row" style="margin-top: 12px;">
                <div class="option-item">
                    <label>è‡ªå®šä¹‰å­—ç¬¦é›†ï¼š</label>
                    <input type="text" style="width: 240px;" class="form-control"
                           placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ä¸Šæ–¹å‹¾é€‰é¡¹"
                           @bind="CustomChars" />
                </div>
                <div class="option-item">
                    <label>åˆ†éš”ç¬¦ï¼š</label>
                    <select class="form-control" style="width: auto;" @bind="Separator">
                        <option value="">æ— </option>
                        <option value="\n">æ¢è¡Œ</option>
                        <option value=",">,ï¼ˆé€—å·ï¼‰</option>
                        <option value=";">;ï¼ˆåˆ†å·ï¼‰</option>
                        <option value=" ">ç©ºæ ¼</option>
                    </select>
                </div>
            </div>

            @* AI Accept [Added]: Charset preview *@
            <div style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">
                å½“å‰å­—ç¬¦æ± ï¼š<code style="word-break: break-all;">@GetCharsetPreview()</code>
                ï¼ˆå…± @GetCharsetLength() ç§å­—ç¬¦ï¼‰
            </div>
        </div>
    </div>

    @* AI Accept [Added]: Action buttons *@
    <div class="btn-group" style="margin-top: 20px; justify-content: center;">
        <button class="btn btn-primary" @onclick="Generate">ğŸ² ç”Ÿæˆ</button>
        <button class="btn btn-secondary" @onclick="CopyAll">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button>
        <button class="btn btn-secondary" @onclick="Clear">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success">@SuccessMessage</div>
    }

    @* AI Accept [Added]: Results display *@
    @if (Results.Any())
    {
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <span>ç”Ÿæˆç»“æœï¼ˆ@Results.Count æ¡ï¼Œæ¯æ¡ @Length å­—ç¬¦ï¼‰</span>
            </div>
            <div class="card-body">
                <ul class="result-list">
                    @for (int i = 0; i < Results.Count; i++)
                    {
                        var index = i;
                        <li class="result-item">
                            <code style="flex: 1; overflow-x: auto; white-space: nowrap;">@Results[index]</code>
                            <button class="btn btn-sm btn-secondary" @onclick="() => CopySingle(index)">å¤åˆ¶</button>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
</div>

@code {
    // AI Accept [Added]: Random string generator page logic
    private int Length { get; set; } = 16;
    private int Count { get; set; } = 5;
    private bool IncludeUpper { get; set; } = true;
    private bool IncludeLower { get; set; } = true;
    private bool IncludeNumbers { get; set; } = true;
    private bool IncludeSpecial { get; set; } = false;
    private string CustomChars { get; set; } = string.Empty;
    private string Separator { get; set; } = "";
    private string ErrorMessage { get; set; } = string.Empty;
    private string SuccessMessage { get; set; } = string.Empty;
    private List<string> Results { get; set; } = new();

    private void Generate()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;

        // AI Accept [Added]: Validate inputs
        if (Length < 1 || Length > 1024)
        {
            ErrorMessage = "é•¿åº¦å¿…é¡»åœ¨ 1 ~ 1024 ä¹‹é—´";
            return;
        }
        if (Count < 1 || Count > 100)
        {
            ErrorMessage = "æ•°é‡å¿…é¡»åœ¨ 1 ~ 100 ä¹‹é—´";
            return;
        }

        // AI Accept [Added]: Custom charset takes priority
        if (!string.IsNullOrEmpty(CustomChars))
        {
            Results = GenerateFromCustomChars(Count, Length, CustomChars);
        }
        else
        {
            if (!IncludeUpper && !IncludeLower && !IncludeNumbers && !IncludeSpecial)
            {
                ErrorMessage = "è‡³å°‘é€‰æ‹©ä¸€ç§å­—ç¬¦ç±»å‹ï¼Œåˆ«å…¨ä¸é€‰å•Šï¼";
                return;
            }
            Results = GeneratorService.GenerateMultipleRandomStrings(
                Count, Length, IncludeUpper, IncludeLower, IncludeNumbers, IncludeSpecial);
        }
    }

    /// <summary>
    /// Generate strings from custom character set (AI Accept)
    /// </summary>
    private List<string> GenerateFromCustomChars(int count, int length, string chars)
    {
        var distinctChars = new string(chars.Distinct().ToArray());
        if (distinctChars.Length == 0)
        {
            ErrorMessage = "è‡ªå®šä¹‰å­—ç¬¦é›†ä¸èƒ½ä¸ºç©º";
            return new();
        }

        var results = new List<string>();
        var rng = new Random();
        for (int i = 0; i < count; i++)
        {
            var sb = new System.Text.StringBuilder(length);
            for (int j = 0; j < length; j++)
            {
                sb.Append(distinctChars[rng.Next(distinctChars.Length)]);
            }
            results.Add(sb.ToString());
        }
        return results;
    }

    /// <summary>
    /// Get charset preview string (AI Accept)
    /// </summary>
    private string GetCharsetPreview()
    {
        if (!string.IsNullOrEmpty(CustomChars))
            return new string(CustomChars.Distinct().ToArray());

        var sb = new System.Text.StringBuilder();
        if (IncludeUpper) sb.Append("A-Z ");
        if (IncludeLower) sb.Append("a-z ");
        if (IncludeNumbers) sb.Append("0-9 ");
        if (IncludeSpecial) sb.Append("!@#$%^&*()_+-=[]{}|;:,.<>?");
        return sb.Length > 0 ? sb.ToString().TrimEnd() : "ï¼ˆæœªé€‰æ‹©ä»»ä½•å­—ç¬¦ï¼‰";
    }

    /// <summary>
    /// Get charset total character count (AI Accept)
    /// </summary>
    private int GetCharsetLength()
    {
        if (!string.IsNullOrEmpty(CustomChars))
            return CustomChars.Distinct().Count();

        int total = 0;
        if (IncludeUpper) total += 26;
        if (IncludeLower) total += 26;
        if (IncludeNumbers) total += 10;
        if (IncludeSpecial) total += 27;
        return total;
    }

    /// <summary>
    /// Copy all results to clipboard (AI Accept)
    /// </summary>
    private async Task CopyAll()
    {
        if (!Results.Any()) return;
        var actualSep = Separator switch
        {
            "\\n" => "\n",
            _ => Separator
        };
        var text = string.Join(string.IsNullOrEmpty(actualSep) ? "\n" : actualSep, Results);
        await CopyToClipboard(text);
        SuccessMessage = $"å·²å¤åˆ¶å…¨éƒ¨ {Results.Count} æ¡ç»“æœ";
    }

    /// <summary>
    /// Copy single result to clipboard (AI Accept)
    /// </summary>
    private async Task CopySingle(int index)
    {
        if (index >= 0 && index < Results.Count)
        {
            await CopyToClipboard(Results[index]);
            SuccessMessage = "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿";
        }
    }

    /// <summary>
    /// Clipboard helper via JS interop (AI Accept)
    /// </summary>
    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch
        {
            ErrorMessage = "å¤åˆ¶å¤±è´¥ï¼Œæµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒå‰ªè´´æ¿ API";
        }
    }

    private void Clear()
    {
        Results.Clear();
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
    }
}
