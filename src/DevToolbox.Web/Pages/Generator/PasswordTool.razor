@page "/generator/password"
@inject DevToolbox.Web.Services.IGeneratorService GeneratorService
@inject IJSRuntime JS

<PageTitle>å¯†ç ç”Ÿæˆå™¨ - DevToolbox</PageTitle>

@* AI Accept [Added]: Password generator tool page *@
<div class="tool-page">
    <div class="tool-header">
        <h1>ğŸ” å¯†ç ç”Ÿæˆå™¨</h1>
        <p>ç”Ÿæˆé«˜å¼ºåº¦å®‰å…¨å¯†ç ï¼Œä¿è¯æ¯ç§é€‰ä¸­å­—ç¬¦ç±»å‹è‡³å°‘å‡ºç°ä¸€æ¬¡ï¼Œä½¿ç”¨åŠ å¯†å®‰å…¨éšæœºæ•°</p>
    </div>

    @* AI Accept [Added]: Password options card *@
    <div class="card">
        <div class="card-header">
            <span>âš™ï¸ å¯†ç é€‰é¡¹</span>
        </div>
        <div class="card-body">
            <div class="options-row">
                <div class="option-item">
                    <label>å¯†ç é•¿åº¦ï¼š</label>
                    <input type="number" min="4" max="128" style="width: 80px;" class="form-control"
                           @bind="Length" />
                </div>
                <div class="option-item">
                    <label>
                        <input type="range" min="4" max="128" @bind="Length" @bind:event="oninput"
                               style="width: 180px; vertical-align: middle;" />
                        @Length å­—ç¬¦
                    </label>
                </div>
                <div class="option-item">
                    <label>ç”Ÿæˆæ•°é‡ï¼š</label>
                    <input type="number" min="1" max="50" style="width: 70px;" class="form-control"
                           @bind="Count" />
                </div>
            </div>

            @* AI Accept [Added]: Character type checkboxes *@
            <div class="options-row" style="margin-top: 12px;">
                <div class="option-item">
                    <input type="checkbox" id="pwd-upper" @bind="IncludeUpper" />
                    <label for="pwd-upper">å¤§å†™å­—æ¯ (A-Z)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="pwd-lower" @bind="IncludeLower" />
                    <label for="pwd-lower">å°å†™å­—æ¯ (a-z)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="pwd-numbers" @bind="IncludeNumbers" />
                    <label for="pwd-numbers">æ•°å­— (0-9)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="pwd-special" @bind="IncludeSpecial" />
                    <label for="pwd-special">ç‰¹æ®Šå­—ç¬¦ (!@@#$%...)</label>
                </div>
            </div>

            @* AI Accept [Added]: Exclude ambiguous + presets *@
            <div class="options-row" style="margin-top: 12px;">
                <div class="option-item">
                    <input type="checkbox" id="pwd-ambiguous" @bind="ExcludeAmbiguous" />
                    <label for="pwd-ambiguous">æ’é™¤æ˜“æ··æ·†å­—ç¬¦ (O/0, l/1/I)</label>
                </div>
            </div>

            @* AI Accept [Added]: Quick presets *@
            <div class="options-row" style="margin-top: 16px;">
                <span style="font-weight: 500; color: var(--text-secondary);">å¿«æ·é¢„è®¾ï¼š</span>
                <button class="btn btn-sm btn-secondary" @onclick='() => ApplyPreset(8, true, true, true, false, false)'>ç®€å• (8ä½)</button>
                <button class="btn btn-sm btn-secondary" @onclick='() => ApplyPreset(16, true, true, true, true, false)'>æ ‡å‡† (16ä½)</button>
                <button class="btn btn-sm btn-secondary" @onclick='() => ApplyPreset(24, true, true, true, true, false)'>é«˜å¼ºåº¦ (24ä½)</button>
                <button class="btn btn-sm btn-secondary" @onclick='() => ApplyPreset(32, true, true, true, true, true)'>æå¼º (32ä½)</button>
            </div>
        </div>
    </div>

    @* AI Accept [Added]: Action buttons *@
    <div class="btn-group" style="margin-top: 20px; justify-content: center;">
        <button class="btn btn-primary" @onclick="Generate">ğŸ” ç”Ÿæˆå¯†ç </button>
        <button class="btn btn-secondary" @onclick="CopyAll">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button>
        <button class="btn btn-secondary" @onclick="Clear">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }
    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success">@SuccessMessage</div>
    }

    @* AI Accept [Added]: Results with strength indicator *@
    @if (Results.Any())
    {
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <span>ç”Ÿæˆç»“æœï¼ˆ@Results.Count æ¡ï¼‰</span>
            </div>
            <div class="card-body">
                @foreach (var item in Results)
                {
                    <div class="pwd-result-item">
                        <div class="pwd-result-top">
                            <code class="pwd-result-text">@item.Password</code>
                            <button class="btn btn-sm btn-secondary" @onclick="() => CopySingle(item.Password)">å¤åˆ¶</button>
                        </div>
                        <div class="pwd-strength-row">
                            <div class="pwd-strength-bar">
                                <div class="pwd-strength-fill pwd-strength-@item.Strength.Level.ToString().ToLower()"
                                     style="width: @(item.Strength.Score)%;"></div>
                            </div>
                            <span class="pwd-strength-label pwd-strength-text-@item.Strength.Level.ToString().ToLower()">
                                @item.Strength.Label (@item.Strength.Score åˆ† Â· @item.Strength.EntropyBits.ToString("F1") bits)
                            </span>
                        </div>
                        @if (item.Strength.Suggestions.Any())
                        {
                            <div class="pwd-suggestions">
                                @foreach (var tip in item.Strength.Suggestions)
                                {
                                    <span class="pwd-suggestion-tag">ğŸ’¡ @tip</span>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    @* AI Accept [Added]: Password strength checker section *@
    <div class="mapping-divider">ğŸ“Š å¯†ç å¼ºåº¦æ£€æµ‹</div>

    <div class="card">
        <div class="card-header">
            <span>è¾“å…¥å·²æœ‰å¯†ç æ£€æµ‹å¼ºåº¦</span>
        </div>
        <div class="card-body">
            <div class="form-group">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="@(ShowCheckPassword ? "text" : "password")"
                           class="form-control" style="flex: 1; font-family: 'Consolas', monospace;"
                           placeholder="è¾“å…¥å¯†ç è¿›è¡Œå¼ºåº¦æ£€æµ‹..."
                           @bind="CheckPassword"
                           @bind:event="oninput" />
                    <button class="btn btn-sm btn-secondary" @onclick="ToggleShowPassword">
                        @(ShowCheckPassword ? "ğŸ™ˆ éšè—" : "ğŸ‘ï¸ æ˜¾ç¤º")
                    </button>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(CheckPassword))
            {
                var checkResult = GeneratorService.EvaluateStrength(CheckPassword);
                <div class="pwd-strength-row" style="margin-top: 8px;">
                    <div class="pwd-strength-bar">
                        <div class="pwd-strength-fill pwd-strength-@checkResult.Level.ToString().ToLower()"
                             style="width: @(checkResult.Score)%;"></div>
                    </div>
                    <span class="pwd-strength-label pwd-strength-text-@checkResult.Level.ToString().ToLower()">
                        @checkResult.Label (@checkResult.Score åˆ† Â· @checkResult.EntropyBits.ToString("F1") bits ç†µ)
                    </span>
                </div>
                <div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">
                    é•¿åº¦ï¼š@CheckPassword.Length å­—ç¬¦
                </div>
                @if (checkResult.Suggestions.Any())
                {
                    <div class="pwd-suggestions" style="margin-top: 8px;">
                        @foreach (var tip in checkResult.Suggestions)
                        {
                            <span class="pwd-suggestion-tag">ğŸ’¡ @tip</span>
                        }
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    // AI Accept [Added]: Password generator page state
    private int Length { get; set; } = 16;
    private int Count { get; set; } = 5;
    private bool IncludeUpper { get; set; } = true;
    private bool IncludeLower { get; set; } = true;
    private bool IncludeNumbers { get; set; } = true;
    private bool IncludeSpecial { get; set; } = true;
    private bool ExcludeAmbiguous { get; set; } = false;
    private string ErrorMessage { get; set; } = string.Empty;
    private string SuccessMessage { get; set; } = string.Empty;
    private List<PasswordResultItem> Results { get; set; } = new();

    // AI Accept [Added]: Strength checker state
    private string CheckPassword { get; set; } = string.Empty;
    private bool ShowCheckPassword { get; set; } = false;

    /// <summary>
    /// Password result with strength info (AI Accept)
    /// </summary>
    private class PasswordResultItem
    {
        public string Password { get; set; } = string.Empty;
        public DevToolbox.Web.Services.PasswordStrengthResult Strength { get; set; } = new();
    }

    /// <summary>
    /// Apply quick preset (AI Accept)
    /// </summary>
    private void ApplyPreset(int length, bool upper, bool lower, bool numbers, bool special, bool excludeAmbiguous)
    {
        Length = length;
        IncludeUpper = upper;
        IncludeLower = lower;
        IncludeNumbers = numbers;
        IncludeSpecial = special;
        ExcludeAmbiguous = excludeAmbiguous;
    }

    /// <summary>
    /// Generate passwords (AI Accept)
    /// </summary>
    private void Generate()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;

        if (Length < 4 || Length > 128)
        {
            ErrorMessage = "å¯†ç é•¿åº¦å¿…é¡»åœ¨ 4 ~ 128 ä¹‹é—´";
            return;
        }
        if (Count < 1 || Count > 50)
        {
            ErrorMessage = "ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨ 1 ~ 50 ä¹‹é—´";
            return;
        }
        if (!IncludeUpper && !IncludeLower && !IncludeNumbers && !IncludeSpecial)
        {
            ErrorMessage = "è‡³å°‘é€‰æ‹©ä¸€ç§å­—ç¬¦ç±»å‹ï¼";
            return;
        }

        // AI Accept [Added]: Check minimum length for selected types
        int requiredTypes = (IncludeUpper ? 1 : 0) + (IncludeLower ? 1 : 0) +
                           (IncludeNumbers ? 1 : 0) + (IncludeSpecial ? 1 : 0);
        if (Length < requiredTypes)
        {
            ErrorMessage = $"å¯†ç é•¿åº¦ï¼ˆ{Length}ï¼‰ä¸èƒ½å°äºé€‰ä¸­çš„å­—ç¬¦ç±»å‹æ•°ï¼ˆ{requiredTypes}ï¼‰ï¼Œå¦åˆ™æ— æ³•ä¿è¯æ¯ç§ç±»å‹éƒ½å‡ºç°";
            return;
        }

        var passwords = GeneratorService.GenerateMultiplePasswords(
            Count, Length, IncludeUpper, IncludeLower, IncludeNumbers, IncludeSpecial, ExcludeAmbiguous);

        Results = passwords.Select(p => new PasswordResultItem
        {
            Password = p,
            Strength = GeneratorService.EvaluateStrength(p)
        }).ToList();
    }

    private void ToggleShowPassword() => ShowCheckPassword = !ShowCheckPassword;

    /// <summary>
    /// Copy single password (AI Accept)
    /// </summary>
    private async Task CopySingle(string password)
    {
        SuccessMessage = string.Empty;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", password);
            SuccessMessage = "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿";
        }
        catch
        {
            ErrorMessage = "å¤åˆ¶å¤±è´¥ï¼Œæµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒå‰ªè´´æ¿ API";
        }
    }

    /// <summary>
    /// Copy all passwords (AI Accept)
    /// </summary>
    private async Task CopyAll()
    {
        if (!Results.Any()) return;
        SuccessMessage = string.Empty;
        try
        {
            var text = string.Join("\n", Results.Select(r => r.Password));
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            SuccessMessage = $"å·²å¤åˆ¶å…¨éƒ¨ {Results.Count} æ¡å¯†ç ";
        }
        catch
        {
            ErrorMessage = "å¤åˆ¶å¤±è´¥ï¼Œæµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒå‰ªè´´æ¿ API";
        }
    }

    private void Clear()
    {
        Results.Clear();
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
    }
}
