@page "/crypto/aes"
@using DevToolbox.Web.Services
@inject ICryptoService CryptoService

<PageTitle>AES åŠ å¯†/è§£å¯† - DevToolbox</PageTitle>

@* AES encryption/decryption tool page (AI Accept) *@
<div class="tool-page">
    <div class="tool-header">
        <h1>ğŸ” AES åŠ å¯†/è§£å¯†</h1>
        <p>AES å¯¹ç§°åŠ å¯†å·¥å…·ï¼Œæ”¯æŒ 128/192/256 ä½å¯†é’¥ï¼ŒCBC/ECB æ¨¡å¼ï¼ŒPKCS7 å¡«å……</p>
    </div>

    @* Options panel *@
    <div class="options-panel">
        <div class="options-title">åŠ å¯†å‚æ•°</div>
        <div class="options-row">
            <div class="option-item">
                <label class="form-label" style="margin: 0;">å¯†é’¥é•¿åº¦ï¼š</label>
                <select class="form-control" style="width: auto; min-width: 100px;" @bind="KeySize">
                    <option value="128">AES-128</option>
                    <option value="192">AES-192</option>
                    <option value="256">AES-256</option>
                </select>
            </div>
            <div class="option-item">
                <label class="form-label" style="margin: 0;">åŠ å¯†æ¨¡å¼ï¼š</label>
                <select class="form-control" style="width: auto; min-width: 100px;" @bind="Mode">
                    <option value="CBC">CBC</option>
                    <option value="ECB">ECB</option>
                </select>
            </div>
            <div class="option-item">
                <label class="form-label" style="margin: 0;">è¾“å‡ºæ ¼å¼ï¼š</label>
                <select class="form-control" style="width: auto; min-width: 100px;" @bind="OutputFormat">
                    <option value="Base64">Base64</option>
                    <option value="Hex">Hex</option>
                </select>
            </div>
        </div>
    </div>

    @* Key & IV inputs *@
    <div class="tool-content" style="margin-top: 20px;">
        <div class="card">
            <div class="card-header">
                <span>ğŸ”‘ Key (å¯†é’¥)</span>
                <button class="btn btn-sm btn-primary" @onclick="GenerateKey">éšæœºç”Ÿæˆ</button>
            </div>
            <div class="card-body">
                <input type="text" class="form-control"
                       @bind="Key"
                       placeholder="è¾“å…¥å¯†é’¥ï¼ˆæ”¯æŒ UTF-8 æ–‡æœ¬æˆ– Hex å­—ç¬¦ä¸²ï¼‰..." />
                <p style="color: var(--text-secondary); font-size: 12px; margin: 6px 0 0;">
                    å½“å‰éœ€è¦ @(KeySize / 8) å­—èŠ‚ | Hex æ ¼å¼éœ€ @(KeySize / 4) ä¸ªå­—ç¬¦
                </p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>ğŸ“ IV (åˆå§‹å‘é‡)</span>
                <button class="btn btn-sm btn-primary" @onclick="GenerateIv" disabled="@IsEcbMode">éšæœºç”Ÿæˆ</button>
            </div>
            <div class="card-body">
                <input type="text" class="form-control"
                       @bind="Iv"
                       disabled="@IsEcbMode"
                       placeholder="@(IsEcbMode ? "ECB æ¨¡å¼ä¸éœ€è¦ IV" : "è¾“å…¥ IVï¼ˆ16 å­—èŠ‚ï¼Œæ”¯æŒ UTF-8 æˆ– Hexï¼‰...")" />
                <p style="color: var(--text-secondary); font-size: 12px; margin: 6px 0 0;">
                    @(IsEcbMode ? "ECB æ¨¡å¼ä¸ä½¿ç”¨ IV" : "å›ºå®š 16 å­—èŠ‚ | Hex æ ¼å¼éœ€ 32 ä¸ªå­—ç¬¦")
                </p>
            </div>
        </div>
    </div>

    @* Input & Output text areas *@
    <div class="tool-content" style="margin-top: 20px;">
        <div class="card">
            <div class="card-header">
                <span>ğŸ“ è¾“å…¥</span>
                <button class="btn btn-sm btn-secondary" @onclick="ClearAll">æ¸…ç©º</button>
            </div>
            <div class="card-body">
                <textarea class="form-control"
                          @bind="InputText"
                          placeholder="åŠ å¯†æ—¶è¾“å…¥æ˜æ–‡ï¼Œè§£å¯†æ—¶è¾“å…¥å¯†æ–‡..."></textarea>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>ğŸ“¤ è¾“å‡º</span>
                <button class="btn btn-sm btn-secondary" @onclick="CopyOutput">å¤åˆ¶</button>
            </div>
            <div class="card-body">
                <textarea class="form-control"
                          @bind="OutputText"
                          readonly
                          placeholder="ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            </div>
        </div>
    </div>

    @* Action buttons *@
    <div class="btn-group" style="margin-top: 20px; justify-content: center;">
        <button class="btn btn-primary" @onclick="Encrypt">ğŸ”’ åŠ å¯†</button>
        <button class="btn btn-success" @onclick="Decrypt">ğŸ”“ è§£å¯†</button>
        <button class="btn btn-secondary" @onclick="Swap">â‡„ äº¤æ¢</button>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success">@SuccessMessage</div>
    }
</div>

@code {
    // AI Accept [Added]: AES tool state
    private string InputText { get; set; } = string.Empty;
    private string OutputText { get; set; } = string.Empty;
    private string Key { get; set; } = string.Empty;
    private string Iv { get; set; } = string.Empty;
    private int KeySize { get; set; } = 256;
    private string Mode { get; set; } = "CBC";
    private string OutputFormat { get; set; } = "Base64";
    private string ErrorMessage { get; set; } = string.Empty;
    private string SuccessMessage { get; set; } = string.Empty;

    private bool IsEcbMode => Mode == "ECB";

    /// <summary>
    /// Encrypt plain text (AI Accept)
    /// </summary>
    private void Encrypt()
    {
        ClearMessages();

        if (string.IsNullOrWhiteSpace(InputText))
        {
            ErrorMessage = "Please enter plain text to encrypt.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Key))
        {
            ErrorMessage = "Please enter or generate a Key.";
            return;
        }

        if (!IsEcbMode && string.IsNullOrWhiteSpace(Iv))
        {
            ErrorMessage = "CBC mode requires an IV. Please enter or generate one.";
            return;
        }

        try
        {
            OutputText = CryptoService.AesEncrypt(InputText, Key, Iv, KeySize, Mode, OutputFormat);
            SuccessMessage = $"Encrypted successfully. (AES-{KeySize}, {Mode}, {OutputFormat})";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Encryption failed: {ex.Message}";
        }
    }

    /// <summary>
    /// Decrypt cipher text (AI Accept)
    /// </summary>
    private void Decrypt()
    {
        ClearMessages();

        if (string.IsNullOrWhiteSpace(InputText))
        {
            ErrorMessage = "Please enter cipher text to decrypt.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Key))
        {
            ErrorMessage = "Please enter or generate a Key.";
            return;
        }

        if (!IsEcbMode && string.IsNullOrWhiteSpace(Iv))
        {
            ErrorMessage = "CBC mode requires an IV. Please enter or generate one.";
            return;
        }

        try
        {
            OutputText = CryptoService.AesDecrypt(InputText, Key, Iv, KeySize, Mode, OutputFormat);
            SuccessMessage = $"Decrypted successfully. (AES-{KeySize}, {Mode}, {OutputFormat})";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Decryption failed: {ex.Message}";
        }
    }

    /// <summary>
    /// Generate random key (AI Accept)
    /// </summary>
    private void GenerateKey()
    {
        Key = CryptoService.GenerateRandomKey(KeySize);
        ClearMessages();
    }

    /// <summary>
    /// Generate random IV (AI Accept)
    /// </summary>
    private void GenerateIv()
    {
        Iv = CryptoService.GenerateRandomIv();
        ClearMessages();
    }

    /// <summary>
    /// Swap input and output (AI Accept)
    /// </summary>
    private void Swap()
    {
        (InputText, OutputText) = (OutputText, InputText);
        ClearMessages();
    }

    /// <summary>
    /// Copy output to clipboard (AI Accept)
    /// </summary>
    private async Task CopyOutput()
    {
        SuccessMessage = "Copied! (JS interop required for clipboard)";
    }

    /// <summary>
    /// Clear all inputs and outputs (AI Accept)
    /// </summary>
    private void ClearAll()
    {
        InputText = string.Empty;
        OutputText = string.Empty;
        ClearMessages();
    }

    private void ClearMessages()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
    }
}
