@page "/formatter/xml"
@using DevToolbox.Web.Services
@inject IFormatterService FormatterService
@inject IJSRuntime JS

<PageTitle>XML æ ¼å¼åŒ– - DevToolbox</PageTitle>

@* XML formatter tool page (AI Accept) *@
<div class="tool-page">
    <div class="tool-header">
        <h1>ğŸ“„ XML æ ¼å¼åŒ–</h1>
        <p>XML æ ¼å¼åŒ–ç¾åŒ–ã€å‹ç¼©ï¼Œæ”¯æŒè¯­æ³•æ ¡éªŒ</p>
    </div>

    <div class="tool-content">
        <div class="card">
            <div class="card-header">
                <span>è¾“å…¥</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-secondary" @onclick="LoadSample">ç¤ºä¾‹</button>
                    <button class="btn btn-sm btn-secondary" @onclick="Clear">æ¸…ç©º</button>
                </div>
            </div>
            <div class="card-body">
                <textarea class="form-control"
                          @bind="InputText"
                          placeholder="ç²˜è´´ XML å†…å®¹..."></textarea>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>è¾“å‡º</span>
                <button class="btn btn-sm btn-primary" @onclick="CopyOutput">ğŸ“‹ å¤åˆ¶</button>
            </div>
            <div class="card-body">
                <textarea class="form-control"
                          @bind="OutputText"
                          readonly
                          placeholder="ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            </div>
        </div>
    </div>

    <div class="btn-group" style="margin-top: 20px; justify-content: center;">
        <button class="btn btn-primary" @onclick="Format">âœ¨ æ ¼å¼åŒ–</button>
        <button class="btn btn-success" @onclick="Compress">ğŸ“¦ å‹ç¼©</button>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success">@SuccessMessage</div>
    }

    @* AI Accept [Added]: Entity mapping validation section *@
    <div class="mapping-divider">
        <span>ğŸ“‹ XML â†’ C# å®ä½“æ˜ å°„éªŒè¯</span>
    </div>

    <div class="tool-content">
        <div class="card">
            <div class="card-header">
                <span>XML æ•°æ®</span>
                <button class="btn btn-sm btn-secondary" @onclick="LoadMappingSample">ç¤ºä¾‹</button>
            </div>
            <div class="card-body">
                <textarea class="form-control"
                          @bind="MappingXmlText"
                          placeholder="ç²˜è´´ XML æ•°æ®..."></textarea>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>C# å®ä½“å®šä¹‰</span>
                <button class="btn btn-sm btn-secondary" @onclick="LoadEntitySample">ç¤ºä¾‹</button>
            </div>
            <div class="card-body">
                <textarea class="form-control"
                          @bind="EntityDefText"
                          placeholder="ç²˜è´´ C# å®ä½“ç±»å®šä¹‰ï¼Œå¦‚ï¼š&#10;public class User&#10;{&#10;    public int Id { get; set; }&#10;    public string Name { get; set; }&#10;}"></textarea>
            </div>
        </div>
    </div>

    <div class="btn-group" style="margin-top: 20px; justify-content: center; align-items: center;">
        <label class="option-item">
            <input type="radio" name="xmlMappingMode" value="false"
                   checked="@(!MappingIsCollection)"
                   @onchange="@(() => MappingIsCollection = false)" />
            <span>å¯¹è±¡</span>
        </label>
        <label class="option-item">
            <input type="radio" name="xmlMappingMode" value="true"
                   checked="@MappingIsCollection"
                   @onchange="@(() => MappingIsCollection = true)" />
            <span>é›†åˆ</span>
        </label>
        <button class="btn btn-primary" @onclick="ValidateMapping">ğŸ” éªŒè¯æ˜ å°„</button>
    </div>

    @if (!string.IsNullOrEmpty(MappingErrorMessage))
    {
        <div class="alert alert-danger">@MappingErrorMessage</div>
    }

    @* AI Accept [Added]: Mapping result display *@
    @if (MappingResult != null && string.IsNullOrEmpty(MappingResult.ErrorMessage))
    {
        <div class="mapping-summary" style="margin-top: 16px;">
            <span class="jwt-badge @(MappingResult.Success ? "jwt-badge-valid" : "jwt-badge-expired")">
                @(MappingResult.Success ? "âœ… å…¨éƒ¨é€šè¿‡" : "âŒ å­˜åœ¨å¤±è´¥")
            </span>
            <span class="jwt-badge jwt-badge-info">
                æ€»è®¡ @MappingResult.TotalFields ä¸ªå­—æ®µ
            </span>
            <span class="jwt-badge jwt-badge-valid">
                æˆåŠŸ @MappingResult.SuccessCount
            </span>
            @if (MappingResult.FailedCount > 0)
            {
                <span class="jwt-badge jwt-badge-expired">
                    å¤±è´¥ @MappingResult.FailedCount
                </span>
            }
        </div>

        <div class="card" style="margin-top: 16px;">
            <div class="card-body" style="overflow-x: auto;">
                <table class="jwt-claims-table mapping-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">çŠ¶æ€</th>
                            <th>å±æ€§å</th>
                            <th>C# ç±»å‹</th>
                            <th>XML å­—æ®µ</th>
                            <th>XML å€¼</th>
                            <th>XML ç±»å‹</th>
                            <th>åŸå› </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var field in MappingResult.Fields)
                        {
                            <tr class="@(field.IsSuccess ? "mapping-status-ok" : "mapping-status-fail")">
                                <td>@(field.IsSuccess ? "âœ…" : "âŒ")</td>
                                <td><strong>@field.PropertyName</strong></td>
                                <td><code>@field.PropertyType</code></td>
                                <td>@(string.IsNullOrEmpty(field.JsonFieldName) ? "â€”" : field.JsonFieldName)</td>
                                <td class="jwt-claim-value">@(string.IsNullOrEmpty(field.JsonValue) ? "â€”" : field.JsonValue)</td>
                                <td>@(string.IsNullOrEmpty(field.JsonValueKind) ? "â€”" : field.JsonValueKind)</td>
                                <td class="@(field.IsSuccess ? "" : "mapping-reason-fail")">@(string.IsNullOrEmpty(field.Reason) ? "â€”" : field.Reason)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    // AI Accept [Added]: XML formatter tool state
    private string InputText { get; set; } = string.Empty;
    private string OutputText { get; set; } = string.Empty;
    private string ErrorMessage { get; set; } = string.Empty;
    private string SuccessMessage { get; set; } = string.Empty;

    // AI Accept [Added]: Entity mapping state
    private string MappingXmlText { get; set; } = string.Empty;
    private string EntityDefText { get; set; } = string.Empty;
    private bool MappingIsCollection { get; set; } = false;
    private string MappingErrorMessage { get; set; } = string.Empty;
    private EntityMappingResult? MappingResult { get; set; }

    /// <summary>
    /// Format XML with indentation (AI Accept)
    /// </summary>
    private void Format()
    {
        ClearMessages();

        if (string.IsNullOrWhiteSpace(InputText))
        {
            ErrorMessage = "è¯·è¾“å…¥ XML å†…å®¹ã€‚";
            return;
        }

        try
        {
            OutputText = FormatterService.XmlFormat(InputText);
            SuccessMessage = "æ ¼å¼åŒ–æˆåŠŸã€‚";
        }
        catch (System.Xml.XmlException ex)
        {
            ErrorMessage = $"æ— æ•ˆçš„ XML: {ex.Message}";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"æ ¼å¼åŒ–å¤±è´¥: {ex.Message}";
        }
    }

    /// <summary>
    /// Compress XML (AI Accept)
    /// </summary>
    private void Compress()
    {
        ClearMessages();

        if (string.IsNullOrWhiteSpace(InputText))
        {
            ErrorMessage = "è¯·è¾“å…¥ XML å†…å®¹ã€‚";
            return;
        }

        try
        {
            OutputText = FormatterService.XmlCompress(InputText);
            SuccessMessage = "å‹ç¼©æˆåŠŸã€‚";
        }
        catch (System.Xml.XmlException ex)
        {
            ErrorMessage = $"æ— æ•ˆçš„ XML: {ex.Message}";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"å‹ç¼©å¤±è´¥: {ex.Message}";
        }
    }

    /// <summary>
    /// Copy output to clipboard via JS interop (AI Accept)
    /// </summary>
    private async Task CopyOutput()
    {
        ClearMessages();

        if (string.IsNullOrWhiteSpace(OutputText))
        {
            ErrorMessage = "æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹ã€‚";
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", OutputText);
            SuccessMessage = "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!";
        }
        catch
        {
            ErrorMessage = "å‰ªè´´æ¿è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚";
        }
    }

    /// <summary>
    /// Load sample XML (AI Accept)
    /// </summary>
    private void LoadSample()
    {
        InputText = "<root><name>DevToolbox</name><version>1.0.0</version><features><item>encoding</item><item>crypto</item><item>formatter</item></features><config theme=\"light\" language=\"zh-CN\" maxItems=\"100\" /></root>";
        OutputText = string.Empty;
        ClearMessages();
    }

    private void Clear()
    {
        InputText = string.Empty;
        OutputText = string.Empty;
        ClearMessages();
    }

    private void ClearMessages()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
    }

    /// <summary>
    /// Validate XML to C# entity mapping (AI Accept)
    /// </summary>
    private void ValidateMapping()
    {
        MappingErrorMessage = string.Empty;
        MappingResult = null;

        if (string.IsNullOrWhiteSpace(MappingXmlText))
        {
            MappingErrorMessage = "è¯·è¾“å…¥ XML æ•°æ®ã€‚";
            return;
        }

        if (string.IsNullOrWhiteSpace(EntityDefText))
        {
            MappingErrorMessage = "è¯·è¾“å…¥ C# å®ä½“ç±»å®šä¹‰ã€‚";
            return;
        }

        try
        {
            MappingResult = FormatterService.MapXmlToEntity(MappingXmlText, EntityDefText, MappingIsCollection);

            if (!string.IsNullOrEmpty(MappingResult.ErrorMessage))
            {
                MappingErrorMessage = MappingResult.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            MappingErrorMessage = $"éªŒè¯å¤±è´¥ï¼š{ex.Message}";
        }
    }

    /// <summary>
    /// Load sample XML for mapping validation (AI Accept)
    /// </summary>
    private void LoadMappingSample()
    {
        MappingXmlText = @"<User>
  <Id>1</Id>
  <Name>å¼ ä¸‰</Name>
  <Age>28</Age>
  <Email>zhangsan@example.com</Email>
  <IsActive>true</IsActive>
  <Score>95.5</Score>
  <CreatedAt>2024-01-15T10:30:00</CreatedAt>
  <Tags>
    <string>dev</string>
    <string>test</string>
  </Tags>
  <Address>
    <City>åŒ—äº¬</City>
    <Zip>100000</Zip>
  </Address>
</User>";
        MappingErrorMessage = string.Empty;
        MappingResult = null;
    }

    /// <summary>
    /// Load sample C# entity definition (AI Accept)
    /// </summary>
    private void LoadEntitySample()
    {
        EntityDefText = @"public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
    public string Email { get; set; }
    public bool IsActive { get; set; }
    public double Score { get; set; }
    public DateTime CreatedAt { get; set; }
    public List<string> Tags { get; set; }
    public Address Address { get; set; }
}";
        MappingErrorMessage = string.Empty;
        MappingResult = null;
    }
}
