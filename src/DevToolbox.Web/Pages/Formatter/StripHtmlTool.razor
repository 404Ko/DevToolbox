@page "/formatter/strip-html"
@using DevToolbox.Web.Services
@inject IEncodingService EncodingService
@inject IJSRuntime JS

<PageTitle>å»é™¤HTMLæ ‡ç­¾ - DevToolbox</PageTitle>

@* HTML strip tool page (AI Accept) *@
<div class="tool-page">
    <div class="tool-header">
        <h1>ğŸ§¹ å»é™¤HTMLæ ‡ç­¾</h1>
        <p>å»é™¤ HTML æ ‡ç­¾ï¼Œæå–çº¯æ–‡æœ¬å†…å®¹ï¼Œæ”¯æŒä¿ç•™æ¢è¡Œ</p>
    </div>

    <div class="tool-content">
        <div class="card">
            <div class="card-header">
                <span>HTML è¾“å…¥</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-secondary" @onclick="LoadSample">ç¤ºä¾‹</button>
                    <button class="btn btn-sm btn-secondary" @onclick="Clear">æ¸…ç©º</button>
                </div>
            </div>
            <div class="card-body">
                <textarea class="form-control"
                          @bind="InputText"
                          placeholder="ç²˜è´´ HTML å†…å®¹..."></textarea>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>çº¯æ–‡æœ¬è¾“å‡º</span>
                <button class="btn btn-sm btn-primary" @onclick="CopyOutput">ğŸ“‹ å¤åˆ¶</button>
            </div>
            <div class="card-body">
                <textarea class="form-control"
                          @bind="OutputText"
                          readonly
                          placeholder="ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            </div>
        </div>
    </div>

    @* AI Accept [Added]: Options panel *@
    <div class="options-panel" style="margin-top: 16px;">
        <div class="options-title">é€‰é¡¹</div>
        <div class="options-row">
            <label class="option-item">
                <input type="checkbox" @bind="KeepNewlines" />
                <span>ä¿ç•™å—çº§æ ‡ç­¾æ¢è¡Œï¼ˆbr/p/div/h1~h6/li ç­‰ï¼‰</span>
            </label>
        </div>
    </div>

    <div class="btn-group" style="margin-top: 20px; justify-content: center;">
        <button class="btn btn-primary" @onclick="StripTags">ğŸ§¹ å»é™¤æ ‡ç­¾</button>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success">@SuccessMessage</div>
    }

    @* AI Accept [Added]: Statistics section *@
    @if (Stats != null && Stats.TagCount > 0)
    {
        <div class="mapping-divider">
            <span>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</span>
        </div>

        <div class="mapping-summary">
            <span class="jwt-badge jwt-badge-info">
                åŸå§‹é•¿åº¦ @Stats.OriginalLength å­—ç¬¦
            </span>
            <span class="jwt-badge jwt-badge-valid">
                æå–æ–‡æœ¬ @Stats.StrippedLength å­—ç¬¦
            </span>
            <span class="jwt-badge jwt-badge-expired">
                å»é™¤ @Stats.RemovedChars å­—ç¬¦
            </span>
            <span class="jwt-badge jwt-badge-info">
                å…± @Stats.TagCount ä¸ªæ ‡ç­¾
            </span>
        </div>

        @if (Stats.TagBreakdown.Count > 0)
        {
            <div class="card" style="margin-top: 16px;">
                <div class="card-header">
                    <span>æ ‡ç­¾åˆ†å¸ƒ</span>
                </div>
                <div class="card-body" style="overflow-x: auto;">
                    <table class="jwt-claims-table">
                        <thead>
                            <tr>
                                <th>æ ‡ç­¾å</th>
                                <th>æ•°é‡</th>
                                <th>å æ¯”</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var tag in Stats.TagBreakdown.OrderByDescending(t => t.Value))
                            {
                                <tr>
                                    <td><code>&lt;@tag.Key&gt;</code></td>
                                    <td>@tag.Value</td>
                                    <td>@((tag.Value * 100.0 / Stats.TagCount).ToString("F1"))%</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
</div>

@code {
    // AI Accept [Added]: Strip HTML tool state
    private string InputText { get; set; } = string.Empty;
    private string OutputText { get; set; } = string.Empty;
    private string ErrorMessage { get; set; } = string.Empty;
    private string SuccessMessage { get; set; } = string.Empty;
    private bool KeepNewlines { get; set; } = false;
    private HtmlStripStats? Stats { get; set; }

    /// <summary>
    /// Strip HTML tags from input (AI Accept)
    /// </summary>
    private void StripTags()
    {
        ClearMessages();
        Stats = null;

        if (string.IsNullOrWhiteSpace(InputText))
        {
            ErrorMessage = "è¯·è¾“å…¥ HTML å†…å®¹ã€‚";
            return;
        }

        try
        {
            // AI Accept [Added]: Choose strip mode based on option
            OutputText = KeepNewlines
                ? EncodingService.StripHtmlTagsKeepNewlines(InputText)
                : EncodingService.StripHtmlTags(InputText);

            Stats = EncodingService.GetHtmlStats(InputText);
            SuccessMessage = $"å»é™¤æˆåŠŸï¼Œå…±ç§»é™¤ {Stats.TagCount} ä¸ªæ ‡ç­¾ã€‚";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"å¤„ç†å¤±è´¥ï¼š{ex.Message}";
        }
    }

    /// <summary>
    /// Copy output to clipboard via JS interop (AI Accept)
    /// </summary>
    private async Task CopyOutput()
    {
        ClearMessages();

        if (string.IsNullOrWhiteSpace(OutputText))
        {
            ErrorMessage = "æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹ã€‚";
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", OutputText);
            SuccessMessage = "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!";
        }
        catch
        {
            ErrorMessage = "å‰ªè´´æ¿è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚";
        }
    }

    /// <summary>
    /// Load sample HTML (AI Accept)
    /// </summary>
    private void LoadSample()
    {
        InputText = @"<!DOCTYPE html>
<html>
<head><title>ç¤ºä¾‹é¡µé¢</title></head>
<body>
    <h1>æ¬¢è¿ä½¿ç”¨ DevToolbox</h1>
    <p>è¿™æ˜¯ä¸€ä¸ª<strong>å¼€å‘è€…å·¥å…·ç®±</strong>ï¼Œæä¾›å¤šç§å®ç”¨å·¥å…·ã€‚</p>
    <ul>
        <li>ç¼–ç è½¬æ¢</li>
        <li>åŠ å¯†è§£å¯†</li>
        <li>æ ¼å¼åŒ–å·¥å…·</li>
    </ul>
    <div class=""footer"">
        <p>ç‰ˆæƒæ‰€æœ‰ &copy; 2024 DevToolbox &amp; Contributors</p>
        <a href=""https://example.com"">è®¿é—®å®˜ç½‘</a>
    </div>
</body>
</html>";
        OutputText = string.Empty;
        Stats = null;
        ClearMessages();
    }

    private void Clear()
    {
        InputText = string.Empty;
        OutputText = string.Empty;
        Stats = null;
        ClearMessages();
    }

    private void ClearMessages()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
    }
}
